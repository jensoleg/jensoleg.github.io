angular.module("XivelyApp",["dx","ionic","XivelyApp.services","XivelyApp.filters","XivelyApp.directives"]).filter("int",function(){return function(a){return parseInt(a)||""}}).filter("orderObjectBy",function(){return function(a,b,c){var d=[];return angular.forEach(a,function(a){d.push(a)}),d.sort(function(a,c){return a[b].localeCompare(c[b])}),d.sort(),c&&d.reverse(),d}}).controller("WeatherCtrl",["$window","$scope","$timeout","$ionicScrollDelegate","$rootScope","xively","Weather","Geo","Flickr","$ionicModal",function(a,b,c,d,e,f,g,h,i,j){var k=this;ionic.Platform.ready(function(){StatusBar.hide()}),b.timescale=[{value:300,text:"5 minutes",type:"Raw datapoints"},{value:1800,text:"30 minutes",type:"Raw datapoints"},{value:3600,text:"1 hours",type:"Raw datapoints"},{value:21600,text:"6 hours",type:"Averaged datapoints"},{value:86400,text:"1 day",type:"Averaged datapoints"},{value:604800,text:"7 days",type:"Averaged datapoints"},{value:2592e3,text:"1 month",type:"Averaged datapoints"},{value:7776e3,text:"3 months",type:"Averaged datapoints"}];var l=f.getTimeScale(),m=_.find(b.timescale,{value:l});b.timeScale=m,b.activeBgImageIndex=0,e.currentDataStream={},b.gaugeScale={},b.gaugeRange={},b.gaugeValue={},b.gaugeSubvalues=[],b.viewXively=!1,b.gaugeSettings={subvalues:b.gaugeSubvalues,scale:b.gaugeScale,rangeContainer:b.gaugeRange,tooltip:{enabled:!0},value:b.gaugeValue,subvalueIndicator:{offset:-10}},b.chartData=[],b.chartSettings={dataSource:b.chartData,argumentAxis:{argumentType:"datetime",label:{format:"H:mm",color:"white"},valueMarginsEnabled:!1,tick:{visible:!0}},valueAxis:{valueMarginsEnabled:!1,tick:{visible:!0},type:"continuous",valueType:"numeric",tickInterval:.5,grid:{visible:!1},label:{visible:!0,color:"white"}},series:[{argumentField:"at",valueField:"value",type:"line",point:{visible:!1},style:{opacity:.7},color:"rgba(255,255,255,0.9)",hoverStyle:{color:"rgb(74, 135, 238)"}}],legend:{visible:!1},tooltip:{enabled:!0},crosshair:{enabled:!0,horizontalLine:{color:"white",dashStyle:"longDash"},verticalLine:{color:"white",dashStyle:"dotdashdot"},opacity:.8}},b.toggleView=function(){b.viewXively=!b.viewXively,d.scrollBottom(!0)},b.selectAction=function(a){f.setTimeScale(a.value)},b.showSettings=function(){b.settingsModal?b.settingsModal.show():j.fromTemplateUrl("settings.html",function(a){b.settingsModal=a,b.settingsModal.show()},{animation:"slide-in-up"})},b.showData=function(a){angular.isUndefined(e.activeStream)||null===e.activeStream||e.activeStream.id!=e.datastreams[a].id?(f.get(a),e.activeStream=e.datastreams[a]):(e.activeStream=null,b.chartData=null),d.scrollBottom(!0)},b.showValueCtrl=function(a){e.datastreams[a].isSelecting=!0,e.datastreams[a].newValue=e.datastreams[a].current_value},b.setValueCtrl=function(a){e.datastreams[a].isSelecting=!1,e.datastreams[a].current_value=e.datastreams[a].newValue,f.publish(a,e.datastreams[a].current_value)},b.closeValueCtrl=function(a){e.datastreams[a].isSelecting=!1,e.datastreams[a].newValue=e.datastreams[a].current_value},b.toggleCtrlSwitch=function(a){f.publish(a,e.datastreams[a].current_value)},e.$watchCollection("currentDataStream.data",function(a){angular.isDefined(a)&&a.length>0&&null!=e.activeStream?(b.chartData=a,b.chartSettings.dataSource=b.chartData,k.updateGauge(e.activeStream,a[a.length-1].value)):(b.chartData=[],b.chartSettings.dataSource=b.chartData),b.$broadcast("slideBox.update"),d.scrollBottom(!0)}),this.updateGauge=function(a,c){b.gaugeScale={startValue:a.minDomain,endValue:a.maxDomain,majorTick:{tickInterval:5},minorTick:{visible:!0,tickInterval:1},label:{customizeText:function(a){return a.valueText}},valueType:"numeric"},b.gaugeRange={ranges:[{startValue:a.minDomain,endValue:a.minCritical,color:"#0077BE"},{startValue:a.minCritical,endValue:a.maxCritical,color:"#E6E200"},{startValue:a.maxCritical,endValue:a.maxDomain,color:"#77DD77"}],offset:5},b.gaugeValue=c,b.gaugeSubvalues=[a.min_value,a.max_value],b.gaugeSettings.scale=b.gaugeScale,b.gaugeSettings.rangeContainer=b.gaugeRange,b.gaugeSettings.value=b.gaugeValue,b.gaugeSettings.subvalues=b.gaugeSubvalues},b.$on("orientation.changed",function(){d.scrollBottom(!0)}),this.getBackgroundImage=function(a,c,d){i.search(d,a,c).then(function(a){var c=a.photos;c.photo.length&&(b.bgImages=c.photo,k.cycleBgImages())},function(a){console.error("Unable to get Flickr images",a)})},this.getForecast=function(a,c){g.getForecast(a,c).then(function(a){b.forecast=a.forecast.simpleforecast},function(a){alert("Unable to get forecast. Try again later"),console.error(a)}),g.getHourly(a,c).then(function(a){b.hourly=a.hourly_forecast},function(a){alert("Unable to get forecast. Try again later."),console.error(a)})},this.getCurrent=function(a,c){g.getAtLocation(a,c).then(function(a){b.current=a.current_observation,k.getForecast(a.location.lat,a.location.lon)},function(a){alert("Unable to get current conditions"),console.error(a)})},this.cycleBgImages=function(){c(function a(){b.bgImages&&(b.activeBgImage=b.bgImages[b.activeBgImageIndex++%b.bgImages.length]),c(a,12e4)})},b.refreshData=function(a){f.refresh(a),h.getLocation().then(function(a){var b=a.coords.latitude,c=a.coords.longitude;h.reverseGeocode(b,c).then(function(a){k.getBackgroundImage(b,c,a)}),k.getCurrent(b,c)},function(a){alert("Unable to get current location: "+a)})},b.refreshData(!0)}]).controller("SettingsCtrl",["$scope","Settings","scandit",function(a,b,c){var d=this;a.settings=b.getSettings(),a.$watch("settings",function(){b.save()},!0),a.closeSettings=function(){a.modal.hide()},a.$on("$destroy",function(){a.modal.remove()}),d.success=function(b){a.settings.deviceId=b[0]},d.failure=function(){},a.scan=function(){c.scan(d.success,d.failure)}}]),angular.module("XivelyApp.services",["ngResource"]).constant("DEFAULT_SETTINGS",{tempUnits:"c",keyXively:"6kg3pKWwG6eyx2jRWNrTwSmpOFp9B6kSArV9kWm8iLkJ4gaR",feedXively:"673258092",timeScale:3600}).constant("SCANDIT_API_KEY","cFzwjrDwEeOHumeEBBIoRqXMaSSy36Uq4650VHVlShc").constant("WUNDERGROUND_API_KEY","c83d92d7b5befd29").constant("FLICKR_API_KEY","504fd7414f6275eb5b657ddbfba80a2c").factory("cordova",function(){return window.cordova}).factory("Settings",["$rootScope","DEFAULT_SETTINGS",function(a,b){var c={};try{c=JSON.parse(window.localStorage.settings)}catch(d){}c=angular.extend({},b,c),c||(window.localStorage.settings=JSON.stringify(c));var e={getSettings:function(){return c},save:function(){window.localStorage.settings=JSON.stringify(c),a.$broadcast("settings.changed",c)},get:function(a){return c[a]},set:function(a,b){c[a]=b,this.save()},getTempUnits:function(){return c.tempUnits}};return e.save(),e}]).factory("Geo",["$q",function(a){return{reverseGeocode:function(b,c){var d=a.defer(),e=new google.maps.Geocoder;return e.geocode({latLng:new google.maps.LatLng(b,c)},function(a,b){if(b==google.maps.GeocoderStatus.OK){if(a.length>0){for(var c,e,f=a[0],g=[],h=!1,i=!1,j=0;j<f.address_components.length;j++){c=f.address_components[j],e=c.types;for(var k=0;k<e.length;k++)h||"locality"!=e[k]?i||"administrative_area_level_1"!=e[k]||(i=!0):(h=!0,g.push(c.long_name))}d.resolve(g.join(" "))}}else d.reject(a)}),d.promise},getLocation:function(){var b=a.defer();return navigator.geolocation.getCurrentPosition(function(a){b.resolve(a)},function(a){b.reject(a)}),b.promise}}}]).factory("Flickr",["$q","$resource","FLICKR_API_KEY",function(a,b,c){var d="http://api.flickr.com/services/rest/",e=b(d,{method:"flickr.groups.pools.getPhotos",group_id:"1463451@N25",safe_search:1,jsoncallback:"JSON_CALLBACK",api_key:c,format:"json"},{get:{method:"JSONP"}});return{search:function(b,c,d){var f=a.defer();return e.get({tags:b,lat:c,lng:d},function(a){f.resolve(a)},function(a){f.reject(a)}),f.promise}}}]).factory("Weather",["$q","$resource","WUNDERGROUND_API_KEY",function(a,b,c){var d="http://api.wunderground.com/api/"+c,e=b(d+"/geolookup/conditions/q/:coords.json",{callback:"JSON_CALLBACK"},{get:{method:"JSONP"}}),f=b(d+"/forecast/q/:coords.json",{callback:"JSON_CALLBACK"},{get:{method:"JSONP"}}),g=b(d+"/hourly/q/:coords.json",{callback:"JSON_CALLBACK"},{get:{method:"JSONP"}});return{getForecast:function(b,c){var d=a.defer();return f.get({coords:b+","+c},function(a){d.resolve(a)},function(a){d.reject(a)}),d.promise},getHourly:function(b,c){var d=a.defer();return g.get({coords:b+","+c},function(a){d.resolve(a)},function(a){d.reject(a)}),d.promise},getAtLocation:function(b,c){var d=a.defer();return e.get({coords:b+","+c},function(a){d.resolve(a)},function(a){d.reject(a)}),d.promise}}}]).factory("xively",["$rootScope","Settings",function($rootScope,Settings){var _this=this,feed_id=Settings.get("feedXively"),controlTypes=["data","ctrlValue","ctrlSwitch"];return $rootScope.datastreams={},_this.prepareData=function(data){if(data.isSetting=!1,data.newValue=data.current_value,angular.isDefined(data.tags)){var tagString=null,tags=null;for(var i in data.tags)tagString=null===tagString?data.tags[i]:tagString+" ,"+data.tags[i];try{tags=eval("({"+tagString+"})")}catch(e){data.type="undefined"}"undefined"!=data.type&&(data.minDomain=tags.minValue,data.maxDomain=tags.maxValue,data.minCritical=tags.minCritical,data.maxCritical=tags.maxCritical,data.name=tags.name,data.type=tags.type)}return data},_this.init=function(a){var b=Settings.get("keyXively");feed_id=Settings.get("feedXively"),xively.setKey(b),a&&($rootScope.datastreams={},$rootScope.currentDataStream.data=[]),xively.datastream.list(feed_id,function(a){var b=[];angular.forEach(a,function(a){_this.prepareData(a),_.contains(controlTypes,a.type)&&b.push(a)}),$rootScope.$apply(function(){$rootScope.dataPoints=b})})},$rootScope.$watch("dataPoints",function(){angular.forEach($rootScope.dataPoints,function(a){xively.datastream.get(feed_id,a.id,function(b){_this.prepareData(b),$rootScope.datastreams[a.id]=b,xively.datastream.subscribe(feed_id,a.id,function(b,c){_this.prepareData(c),$rootScope.$apply(function(){$rootScope.datastreams[a.id]=c}),a.id==$rootScope.currentDataStream.id&&($rootScope.currentDataStream.id=c.id,$rootScope.currentDataStream.current_value=c.current_value,$rootScope.$apply(function(){$rootScope.currentDataStream.data.push({value:c.current_value,at:c.at})}))})})}),$rootScope.$broadcast("scroll.refreshComplete")}),xively.refresh=function(a){_this.init(a)},xively.setTimeScale=function(a){Settings.set("timeScale",a),xively.get($rootScope.currentDataStream.id)},xively.getTimeScale=function(){return Settings.get("timeScale")},xively.publish=function(a,b){var c={current_value:b};xively.datastream.update(feed_id,a,c,function(){})},xively.get=function(a){var b=Settings.get("timeScale")+"seconds";xively.datapoint.history(feed_id,a,{duration:b,interval:10,limit:1e3},function(b){$rootScope.$apply(function(){$rootScope.currentDataStream.id=a,$rootScope.currentDataStream.data=b})})},xively}]).factory("scandit",["$rootScope","Settings","cordova","SCANDIT_API_KEY",function(a,b,c,d){var e=this;return e.init=function(){},{scan:function(a,b){c.exec(a,b,"ScanditSDK","scan",[d,{beep:!0,"1DScanning":!0,"2DScanning":!0}])}}}]),angular.module("XivelyApp.directives",[]).constant("WEATHER_ICONS",{partlycloudy:"ion-ios7-partlysunny-outline",mostlycloudy:"ion-ios7-partlysunny-outline",cloudy:"ion-ios7-cloudy-outline",rain:"ion-ios7-rainy-outline",tstorms:"ion-ios7-thunderstorm-outline",sunny:"ion-ios7-sunny-outline",clear:"ion-ios7-sunny-outline",nt_clear:"ion-ios7-moon-outline",gauge:"ion-power",power:"ion-ios7-gear-outline"}).directive("weatherIcon",["WEATHER_ICONS",function(a){return{restrict:"E",replace:!0,scope:{icon:"="},template:'<i class="icon" ng-class="weatherIcon"></i>',link:function(b){b.$watch("icon",function(c){if(c){var d=c;b.weatherIcon=d in a?a[d]:a.cloudy}})}}}]).directive("currentTime",["$timeout","$filter",function(a,b){return{restrict:"E",replace:!0,template:'<span class="current-time">{{currentTime}}</span>',scope:{localtz:"="},link:function(c){a(function d(){c.localtz&&(c.currentTime=b("date")(+new Date,"HH:mm")),a(d,500)})}}}]).directive("currentWeather",["$timeout","$rootScope","Settings",function(a,b,c){return{restrict:"E",replace:!0,templateUrl:"templates/current-weather.html",scope:!0,compile:function(){return function(d,e){b.$on("settings.changed",function(){var a=c.get("tempUnits");if(d.forecast){var b=d.forecast,e=d.current;"f"==a?(d.highTemp=b.forecastday[0].high.fahrenheit,d.lowTemp=b.forecastday[0].low.fahrenheit,d.currentTemp=Math.floor(e.temp_f)):(d.highTemp=b.forecastday[0].high.celsius,d.lowTemp=b.forecastday[0].low.celsius,d.currentTemp=Math.floor(e.temp_c))}}),d.$watch("current",function(a){var b=c.get("tempUnits");a&&(d.currentTemp=Math.floor("f"==b?a.temp_f:a.temp_c))}),d.$watch("forecast",function(a){var b=c.get("tempUnits");a&&("f"==b?(d.highTemp=a.forecastday[0].high.fahrenheit,d.lowTemp=a.forecastday[0].low.fahrenheit):(d.highTemp=a.forecastday[0].high.celsius,d.lowTemp=a.forecastday[0].low.celsius))}),a(function(){var b=window.innerHeight,c=e[0].offsetHeight;e[0].style.paddingTop=b-c-25+"px",angular.element(document.querySelector(".scroll-content")).css("-webkit-overflow-scrolling","auto"),a(function(){angular.element(document.querySelector(".scroll-content")).css("-webkit-overflow-scrolling","touch")},50)})}}}}]).directive("xively",["$timeout",function(){return{restrict:"E",replace:!0,templateUrl:"templates/xively.html",link:function(){}}}]).directive("forecast",["$timeout",function(){return{restrict:"E",replace:!0,templateUrl:"templates/forecast.html",link:function(){}}}]).directive("weatherBox",["$timeout",function(){return{restrict:"E",replace:!0,transclude:!0,scope:{title:"@"},template:'<div class="weather-box"><h4 class="title">{{title}}</h4><div ng-transclude></div></div>',link:function(){}}}]).directive("backgroundCycler",["$compile","$animate",function(a,b){var c=function(c,d,e){var f=d.children()[0],g=c.$new();g.url=e;var h=a("<background-image></background-image>")(g);b.enter(h,d,null,function(){}),f&&b.leave(angular.element(f),function(){})};return{restrict:"E",link:function(a,b){a.$watch("activeBgImage",function(d){if(d){var e=d,f="http://farm"+e.farm+".static.flickr.com/"+e.server+"/"+e.id+"_"+e.secret+"_z.jpg";c(a,b,f)}})}}}]).directive("backgroundImage",["$compile","$animate",function(){return{restrict:"E",template:'<div class="bg-image"></div>',replace:!0,scope:!0,link:function(a,b){a.url&&(b[0].style.backgroundImage="url("+a.url+")")}}}]).directive("orientationChange",["$window","$timeout",function(a,b){return{restrict:"A",replace:!0,scope:!0,compile:function(){return function(c,d){a.addEventListener("orientationchange",function(){b(function(){var a=window.innerHeight,b=parseInt(d[0].style.paddingTop),e=d[0].offsetHeight;d[0].style.paddingTop=a-e+b-25+"px",c.$broadcast("orientation.changed")},10)},!1)}}}}]),angular.module("XivelyApp.filters",["XivelyApp.services"]).filter("temp",["Settings",function(a){return function(b){return"f"==a.getTempUnits()?b.fahrenheit:b.celsius}}]).filter("tempEnglish",["Settings",function(a){return function(b){return"f"==a.getTempUnits()?b.english:b.metric}}]).filter("hourFormat",function(){return function(a){var b=parseInt(a),c=b>=12?"PM":"AM",d=b%12||12;return d+c}});