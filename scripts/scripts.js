angular.module("XivelyApp",["dx","ionic","XivelyApp.services","XivelyApp.filters","XivelyApp.directives"]).config(["$stateProvider","$urlRouterProvider",function(a,b){a.state("intro",{url:"/",templateUrl:"intro.html",controller:"IntroCtrl"}).state("main",{url:"/main",templateUrl:"main.html",controller:"WeatherCtrl"}),b.otherwise("/")}]).filter("int",function(){return function(a){return parseInt(a)||""}}).filter("orderObjectBy",function(){return function(a,b,c){var d=[];return angular.forEach(a,function(a){d.push(a)}),d.sort(function(a,c){return a[b].localeCompare(c[b])}),d.sort(),c&&d.reverse(),d}}).controller("IntroCtrl",["$scope","$state","Settings","$ionicSlideBoxDelegate",function(a,b,c,d){a.startApp=function(){b.go("main"),c.set("skipIntro",!0)},a.next=function(){d.next()},a.previous=function(){d.previous()},a.slideChanged=function(b){a.slideIndex=b},c.get("skipIntro")&&b.go("main")}]).controller("WeatherCtrl",["$window","$scope","$timeout","$state","$ionicPlatform","$ionicScrollDelegate","$ionicNavBarDelegate","$ionicLoading","$ionicSlideBoxDelegate","$rootScope","Settings","xively","Weather","Geo","Flickr","$ionicModal","focus",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q){var r=this;ionic.Platform.ready(function(){ionic.Platform.isIOS()&&StatusBar.hide()}),j.$on("$locationChangeStart",function(a){a.preventDefault()}),b.timescale=[{value:300,interval:0,text:"5 minutes",type:"Raw datapoints"},{value:1800,interval:0,text:"30 minutes",type:"Raw datapoints"},{value:3600,interval:0,text:"1 hours",type:"Raw datapoints"},{value:21600,interval:300,text:"6 hours",type:"Averaged datapoints"},{value:86400,interval:300,text:"1 day",type:"Averaged datapoints"},{value:604800,interval:10800,text:"7 days",type:"Averaged datapoints"},{value:2592e3,interval:86400,text:"1 month",type:"Averaged datapoints"},{value:7776e3,interval:86400,text:"3 months",type:"Averaged datapoints"}];var s=l.getTimeScale();b.timeScale=_.find(b.timescale,{value:s.value}),b.activeBgImageIndex=0,j.currentDataStream={},j.activeStream=null,b.activeStreamReady=!1,b.gaugeScale={},b.gaugeRange={},b.gaugeValue=null,b.gaugeSubvalues=[],b.viewXively=!1,b.gaugeSettings={subvalues:b.gaugeSubvalues,scale:b.gaugeScale,rangeContainer:b.gaugeRange,tooltip:{enabled:!0},value:b.gaugeValue,subvalueIndicator:{offset:-10}},b.chartLabel={argumentType:"datetime",label:{format:"H:mm",color:"white"},valueMarginsEnabled:!1,tick:{visible:!0}},b.chartData=[],b.chartSettings={dataSource:b.chartData,argumentAxis:b.chartLabel,valueAxis:{valueMarginsEnabled:!1,tick:{visible:!0},type:"continuous",valueType:"numeric",tickInterval:.5,grid:{visible:!1},label:{visible:!0,color:"white"}},series:[{argumentField:"at",valueField:"value",type:"line",point:{visible:!1},style:{opacity:.7},color:"rgba(255,255,255,0.9)",hoverStyle:{color:"rgb(74, 135, 238)"}}],legend:{visible:!1},tooltip:{enabled:!0},crosshair:{enabled:!0,horizontalLine:{color:"white",dashStyle:"longDash"},verticalLine:{color:"white",dashStyle:"dotdashdot"},opacity:.8}},b.toggleView=function(){b.viewXively=!b.viewXively,f.$getByHandle("details").scrollBottom()},b.selectAction=function(a){b.timeScale=_.find(b.timescale,{value:a.value}),l.setTimeScale(b.timeScale),b.loadXively=!0},b.showSettings=function(){b.settingsModal?b.settingsModal.show():p.fromTemplateUrl("settings.html",function(a){b.settingsModal=a,b.settingsModal.show()},{animation:"slide-in-up"})},b.showData=function(a){angular.isUndefined(j.activeStream)||null===j.activeStream||j.activeStream.id!=j.datastreams[a].id?(b.loadXively=!0,l.get(a),j.activeStream=j.datastreams[a]):(j.activeStream=null,b.activeStreamReady=!1,b.chartData=null,f.$getByHandle("details").scrollBottom())},b.showValueCtrl=function(a){j.datastreams[a].isSelecting=!0,j.datastreams[a].newValue=j.datastreams[a].current_value,q("input-time")},b.setValueCtrl=function(a){j.datastreams[a].isSelecting=!1,j.datastreams[a].current_value=j.datastreams[a].newValue,l.publish(a,j.datastreams[a].current_value)},b.closeValueCtrl=function(a){j.datastreams[a].isSelecting=!1,j.datastreams[a].newValue=j.datastreams[a].current_value},b.toggleCtrlSwitch=function(a){l.publish(a,j.datastreams[a].current_value)},j.$watchCollection("currentDataStream.data",function(a){angular.isDefined(a)&&a.length>0&&null!=j.activeStream?(b.chartLabel.label=b.timeScale.value<=86400?{format:"H:mm",color:"white"}:b.timeScale.value<=604800?{format:"ddd",color:"white"}:b.timeScale.value<=2592e3?{format:"dd-MM",color:"white"}:{format:"MMM",color:"white"},b.chartData=a,b.chartSettings.dataSource=b.chartData,r.updateGauge(j.activeStream,a[a.length-1].value)):(b.chartData=[],b.gaugeValue=null,b.chartSettings.dataSource=b.chartData,b.gaugeSettings.value=b.gaugeValue),b.loadXively=!1,b.activeStreamReady=null!=j.activeStream,i.$getByHandle("charts").update(),f.$getByHandle("details").scrollBottom()}),this.updateGauge=function(a,c){b.gaugeScale={startValue:a.minDomain,endValue:a.maxDomain,majorTick:{tickInterval:5},minorTick:{visible:!0,tickInterval:1},label:{customizeText:function(a){return a.valueText}},valueType:"numeric"},b.gaugeRange={ranges:[{startValue:a.minDomain,endValue:a.minCritical,color:"#0077BE"},{startValue:a.minCritical,endValue:a.maxCritical,color:"#E6E200"},{startValue:a.maxCritical,endValue:a.maxDomain,color:"#77DD77"}],offset:5},b.gaugeValue=c,a.min_value&&a.max_value&&(b.gaugeSubvalues=[a.min_value,a.max_value],b.gaugeSettings.subvalues=b.gaugeSubvalues),b.gaugeSettings.scale=b.gaugeScale,b.gaugeSettings.rangeContainer=b.gaugeRange,b.gaugeSettings.value=b.gaugeValue},this.getBackgroundImage=function(a,c,d){o.search(d,a,c).then(function(a){var c=a.photos;c.photo.length&&(b.bgImages=c.photo,r.cycleBgImages())},function(a){console.error("Unable to get Flickr images",a)})},this.getForecast=function(a,c){m.getForecast(a,c).then(function(a){b.forecast=a.list},function(a){alert("Unable to get forecast. Try again later"),console.error(a)}),m.getHourly(a,c).then(function(a){b.hourly=a.list},function(a){alert("Unable to get forecast. Try again later."),console.error(a)})},this.getCurrent=function(a,c){m.getAtLocation(a,c).then(function(a){b.current=a,r.getForecast(a.coord.lat,a.coord.lon)},function(a){alert("Unable to get current conditions"),console.error(a)})},this.cycleBgImages=function(){c(function a(){b.bgImages&&k.get("useFlickr")&&(b.activeBgImage=b.bgImages[b.activeBgImageIndex++%b.bgImages.length]),c(a,12e4)})},b.refreshData=function(a){a&&(b.loading=h.show({content:'Finding  location... <i class="icon ion-loading-c">',showBackdrop:!0,animation:"fade-in"})),l.refresh(a).then(function(a){a?(r.getCurrent(a.lat,a.lon),n.reverseGeocode(a.lat,a.lon).then(function(c){b.currentCity=c,k.get("useFlickr")?r.getBackgroundImage(a.lat,a.lon,c):b.activeBgImage=null,j.$broadcast("scroll.refreshComplete"),b.loading.hide()})):n.getLocation().then(function(a){var c=a.coords.latitude,d=a.coords.longitude;r.getCurrent(c,d),n.reverseGeocode(c,d).then(function(a){b.currentCity=a,k.get("useFlickr")?r.getBackgroundImage(c,d,a):b.activeBgImage=null}),j.$broadcast("scroll.refreshComplete"),b.loading.hide()},function(a){alert("Unable to get current location: "+a),j.$broadcast("scroll.refreshComplete"),b.loading.hide()})})},b.refreshData(!0)}]).controller("SettingsCtrl",["$scope","$state","Settings","scandit",function(a,b,c,d){var e=this;a.settings=c.getSettings(),a.$watch("settings",function(){c.save()},!0),a.closeSettings=function(){a.modal.hide()},a.intro=function(){c.set("skipIntro",!1),b.go("intro")},a.$on("$destroy",function(){a.modal.remove()}),e.success=function(b){a.settings.deviceId=b[0]},e.failure=function(){},a.scan=function(){d.scan(e.success,e.failure)}}]),angular.module("XivelyApp.services",["ngResource"]).constant("DEFAULT_SETTINGS",{tempUnits:"c",keyXively:"BPWvM1ZU0HLKSHs82lG3x1vdzoOSRomAEVpywvNJwGElgciw",feedXively:"1664985147",useFlickr:!0,useDeviceLoc:!1,timeScale:{value:86400,interval:300,text:"1 day",type:"Averaged datapoints"},skipIntro:!1}).constant("SCANDIT_API_KEY","cFzwjrDwEeOHumeEBBIoRqXMaSSy36Uq4650VHVlShc").constant("FLICKR_API_KEY","504fd7414f6275eb5b657ddbfba80a2c").constant("OPENWEATHER_API_KEY","a8c98220ff98a42893423c2f6627e39f").factory("cordova",function(){return window.cordova}).factory("Settings",["$rootScope","DEFAULT_SETTINGS",function(a,b){var c={};try{c=JSON.parse(window.localStorage.settings)}catch(d){}c=angular.extend({},b,c);var e=c.timeScale;"object"!=typeof e&&(c.timeScale=b.timeScale),c||(window.localStorage.settings=JSON.stringify(c));var f={getSettings:function(){return c},save:function(){window.localStorage.settings=JSON.stringify(c),a.$broadcast("settings.changed",c)},get:function(a){return c[a]},set:function(a,b){c[a]=b,this.save()},getTempUnits:function(){return c.tempUnits}};return f.save(),f}]).factory("Geo",["$q",function(a){return{reverseGeocode:function(b,c){var d=a.defer(),e=new google.maps.Geocoder;return e.geocode({latLng:new google.maps.LatLng(b,c)},function(a,b){if(b==google.maps.GeocoderStatus.OK){if(a.length>0){for(var c,e,f=a[0],g=[],h=!1,i=!1,j=0;j<f.address_components.length;j++){c=f.address_components[j],e=c.types;for(var k=0;k<e.length;k++)h||"locality"!=e[k]?i||"administrative_area_level_1"!=e[k]||(i=!0):(h=!0,g.push(c.long_name))}d.resolve(g.join(" "))}}else d.reject(a)}),d.promise},getLocation:function(){var b=a.defer();return navigator.geolocation.getCurrentPosition(function(a){b.resolve(a)},function(a){b.reject(a)}),b.promise}}}]).factory("Flickr",["$q","$resource","FLICKR_API_KEY",function(a,b,c){var d="https://api.flickr.com/services/rest/",e=b(d,{method:"flickr.groups.pools.getPhotos",group_id:"1463451@N25",safe_search:1,jsoncallback:"JSON_CALLBACK",api_key:c,format:"json"},{get:{method:"JSONP"}});return{search:function(b,c,d){var f=a.defer();return e.get({tags:b,lat:c,lng:d},function(a){f.resolve(a)},function(a){f.reject(a)}),f.promise}}}]).factory("Weather",["$q","$resource","OPENWEATHER_API_KEY",function(a,b,c){var d="http://api.openweathermap.org/data/2.5",e=b(d+"/weather",{callback:"JSON_CALLBACK",APPID:c},{get:{method:"JSONP"}}),f=b(d+"/forecast/daily",{callback:"JSON_CALLBACK",APPID:c},{get:{method:"JSONP"}}),g=b(d+"/forecast",{callback:"JSON_CALLBACK",APPID:c},{get:{method:"JSONP"}});return{getForecast:function(b,c){var d=a.defer();return f.get({lat:b,lon:c},function(a){d.resolve(a)},function(a){d.reject(a)}),d.promise},getHourly:function(b,c){var d=a.defer();return g.get({lat:b,lon:c},function(a){d.resolve(a)},function(a){d.reject(a)}),d.promise},getAtLocation:function(b,c){var d=a.defer();return e.get({lat:b,lon:c},function(a){d.resolve(a)},function(a){d.reject(a)}),d.promise}}}]).factory("xively",["$q","$rootScope","Settings",function($q,$rootScope,Settings){var _this=this,feed_id=Settings.get("feedXively"),key,controlTypes=["data","ctrlValue","ctrlSwitch","ctrlTimeValue"];return $rootScope.datastreams={},_this.prepareData=function(data){if(data.isSetting=!1,data.newValue=data.current_value,angular.isDefined(data.tags)){var tagString=null,tags=null;for(var i in data.tags)tagString=null===tagString?data.tags[i]:tagString+" ,"+data.tags[i];try{tags=eval("({"+tagString+"})")}catch(e){data.type="undefined"}"undefined"!=data.type&&(data.minDomain=tags.min,data.maxDomain=tags.max,data.minCritical=tags.minCritical,data.maxCritical=tags.maxCritical,data.name=tags.name,data.type=tags.type)}return data},$rootScope.$watch("dataPoints",function(){angular.forEach($rootScope.dataPoints,function(a){xively.datastream.get(feed_id,a.id,function(b){_this.prepareData(b),$rootScope.datastreams[a.id]=b,xively.datastream.subscribe(feed_id,a.id,function(b,c){_this.prepareData(c),$rootScope.datastreams[a.id]=c,a.id==$rootScope.currentDataStream.id&&($rootScope.currentDataStream.id=c.id,$rootScope.currentDataStream.current_value=c.current_value,$rootScope.currentDataStream.data.push({value:c.current_value,at:c.at}))})})})}),xively.refresh=function(){var a=$q.defer();return feed_id=Settings.get("feedXively"),key!=Settings.get("keyXively")&&(angular.forEach($rootScope.datastreams,function(a){xively.datastream.unsubscribe(feed_id,a.id)}),$rootScope.datastreams={},$rootScope.currentDataStream={},key=Settings.get("keyXively")),xively.setKey(key),xively.feed.get(feed_id,function(b){var c=[];angular.forEach(b.datastreams,function(a){_this.prepareData(a),_.contains(controlTypes,a.type)&&c.push(a)}),$rootScope.dataPoints=c,a.resolve(Settings.get("useDeviceLoc")?b.location:null)},function(b){a.reject(b)}),a.promise},xively.setTimeScale=function(a){Settings.set("timeScale",a),xively.get($rootScope.currentDataStream.id,a)},xively.getTimeScale=function(){return Settings.get("timeScale")},xively.publish=function(a,b){var c={current_value:b};xively.datastream.update(feed_id,a,c,function(){})},xively.get=function(a,b){var b=Settings.get("timeScale"),c=b.value+"seconds";xively.datapoint.history(feed_id,a,{duration:c,interval:b.interval,limit:1e3},function(b){$rootScope.currentDataStream.data=b,$rootScope.currentDataStream.id=a})},xively}]).factory("scandit",["$rootScope","Settings","cordova","SCANDIT_API_KEY",function(a,b,c,d){var e=this;return e.init=function(){},{scan:function(a,b){c.exec(a,b,"ScanditSDK","scan",[d,{beep:!0,"1DScanning":!0,"2DScanning":!0}])}}}]).factory("focus",["$rootScope","$timeout",function(a,b){return function(c){b(function(){a.$broadcast("focusOn",c)})}}]),angular.module("XivelyApp.directives",[]).constant("WEATHER_ICONS",{"01d":"ion-ios7-sunny-outline","01n":"ion-ios7-moon-outline","02d":"ion-ios7-partlysunny-outline","02n":"ion-ios7-cloudy-night-outline","03d":"ion-ios7-cloudy-outline","03n":"ion-ios7-cloudy-outline","04d":"ion-ios7-cloudy-outline","04n":"ion-ios7-cloudy-outline","09d":"ion-ios7-rainy-outline","09n":"ion-ios7-rainy-outline","10d":"ion-ios7-rainy-outline","10n":"ion-ios7-rainy-outline","11d":"ion-ios7-thunderstorm-outline","11n":"ion-ios7-thunderstorm-outline","13d":"ion-ios7-snowy","13n":"ion-ios7-snowy","50d":"ion-ios7-drag","50n":"ion-ios7-drag"}).directive("weatherIcon",["WEATHER_ICONS",function(a){return{restrict:"E",replace:!0,scope:{icon:"="},template:'<i class="icon" ng-class="weatherIcon"></i>',link:function(b){b.$watch("icon",function(c){if(c){var d=c;b.weatherIcon=d in a?a[d]:a["01d"]}})}}}]).directive("currentTime",["$timeout","$filter",function(a){return{restrict:"E",replace:!0,template:'<span class="current-time">{{currentTime}}</span>',link:function(b){a(function c(){b.currentTime=moment().format("HH:mm"),a(c,500)})}}}]).directive("currentWeather",["$timeout","$rootScope","Settings",function(a){return{restrict:"E",replace:!0,templateUrl:"templates/current-weather.html",scope:!0,link:function(b,c){b.$watch("current",function(){var b=window.innerHeight;c[0].style.paddingTop=b-180-25+"px",angular.element(document.querySelector(".scroll-content")).css("-webkit-overflow-scrolling","auto"),a(function(){angular.element(document.querySelector(".scroll-content")).css("-webkit-overflow-scrolling","touch")},100)})}}}]).directive("xively",["$timeout",function(){return{restrict:"E",replace:!0,templateUrl:"templates/xively.html",link:function(){}}}]).directive("forecast",["$timeout",function(){return{restrict:"E",replace:!0,templateUrl:"templates/forecast.html",link:function(){}}}]).directive("weatherBox",["$timeout",function(){return{restrict:"E",replace:!0,transclude:!0,scope:{title:"@"},template:'<div class="weather-box"><h4 class="title">{{title}}</h4><div ng-transclude></div></div>',link:function(){}}}]).directive("backgroundCycler",["$compile","$animate",function(a,b){var c=function(c,d,e){var f=d.children()[0],g=c.$new();g.url=e;var h=a("<background-image></background-image>")(g);b.enter(h,d,null,function(){}),f&&b.leave(angular.element(f),function(){})},d=function(a,c){var d=c.children()[0];d&&b.leave(angular.element(d),function(){})};return{restrict:"E",link:function(a,b){a.$watch("activeBgImage",function(e){if(e){var f=e,g="http://farm"+f.farm+".static.flickr.com/"+f.server+"/"+f.id+"_"+f.secret+"_z.jpg";c(a,b,g)}else d(a,b)})}}}]).directive("backgroundImage",["$compile","$animate",function(){return{restrict:"E",template:'<div class="bg-image"></div>',replace:!0,scope:!0,link:function(a,b){a.url&&(b[0].style.backgroundImage="url("+a.url+")")}}}]).directive("orientationChange",["$window","$timeout",function(a,b){return{restrict:"A",replace:!0,scope:!0,compile:function(){return function(c,d){a.addEventListener("orientationchange",function(){b(function(){var a=window.innerHeight,b=parseInt(d[0].style.paddingTop),e=d[0].offsetHeight;d[0].style.paddingTop=a-e+b-25+"px",c.$broadcast("orientation.changed")},10)},!1)}}}}]).directive("focusOn",function(){return function(a,b,c){a.$on("focusOn",function(a,d){d===c.focusOn&&b[0].focus()})}}),angular.module("XivelyApp.filters",["XivelyApp.services"]).filter("temp",["Settings",function(a){return function(b){return angular.isUndefined(b)?void 0:Math.round("f"==a.getTempUnits()?1.8*(b-273)+32:b-273)}}]).filter("hourFormat",function(){return function(a){return angular.isUndefined(a)?void 0:moment(a).format("HH:mm")}}).filter("weekday",function(){return function(a){return angular.isUndefined(a)?void 0:moment.unix(a).format("dddd")}});