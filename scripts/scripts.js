angular.module("XivelyApp",["dx","ionic","XivelyApp.services","XivelyApp.filters","XivelyApp.directives"]).constant("WUNDERGROUND_API_KEY","c83d92d7b5befd29").constant("FLICKR_API_KEY","504fd7414f6275eb5b657ddbfba80a2c").filter("int",function(){return function(a){return parseInt(a)||""}}).filter("orderObjectBy",function(){return function(a,b,c){var d=[];return angular.forEach(a,function(a){d.push(a)}),d.sort(function(a,c){return a[b].localeCompare(c[b])}),d.sort(),c&&d.reverse(),d}}).controller("WeatherCtrl",["$scope","$timeout","$location","$ionicScrollDelegate","$rootScope","xively","Weather","Geo","Flickr","$ionicModal",function(a,b,c,d,e,f,g,h,i,j){var k=this;ionic.Platform.ready(function(){StatusBar.hide()}),a.activeBgImageIndex=0,e.currentDataStream={},a.gaugeScale={},a.gaugeRange={},a.gaugeValue={},a.gaugeSubvalues=[],a.viewXively=!1,a.gaugeSettings={subvalues:a.gaugeSubvalues,scale:a.gaugeScale,rangeContainer:a.gaugeRange,tooltip:{enabled:!0},value:a.gaugeValue,subvalueIndicator:{offset:-10}},a.chartData=[],a.chartSettings={dataSource:a.chartData,argumentAxis:{argumentType:"datetime",label:{format:"H:mm",color:"white"},valueMarginsEnabled:!1,tick:{visible:!0}},valueAxis:{valueMarginsEnabled:!1,tick:{visible:!0},type:"continuous",valueType:"numeric",tickInterval:.5,grid:{visible:!1},label:{visible:!0,color:"white"}},series:[{argumentField:"at",valueField:"value",type:"line",point:{visible:!1},style:{opacity:.7},color:"rgba(255,255,255,0.9)",hoverStyle:{color:"rgb(74, 135, 238)"}}],legend:{visible:!1},tooltip:{enabled:!0},crosshair:{enabled:!0,horizontalLine:{color:"white",dashStyle:"longDash"},verticalLine:{color:"white",dashStyle:"dotdashdot"},opacity:.8}},a.toggleView=function(){a.viewXively=!a.viewXively,c.hash("1"),d.anchorScroll()},a.showSettings=function(){a.settingsModal?a.settingsModal.show():j.fromTemplateUrl("settings.html",function(b){a.settingsModal=b,a.settingsModal.show()},{animation:"slide-in-up"})},a.showData=function(b){angular.isUndefined(e.activeStream)||null===e.activeStream||e.activeStream.id!=e.datastreams[b].id?(f.get(b),e.activeStream=e.datastreams[b]):(e.activeStream=null,a.chartData=null,a.$broadcast("scroll.resize"))},a.showValueCtrl=function(a){e.datastreams[a].isSelecting=!0,e.datastreams[a].newValue=e.datastreams[a].current_value},a.setValueCtrl=function(a){e.datastreams[a].isSelecting=!1,e.datastreams[a].current_value=e.datastreams[a].newValue,f.publish(a,e.datastreams[a].current_value)},a.closeValueCtrl=function(a){e.datastreams[a].isSelecting=!1,e.datastreams[a].newValue=e.datastreams[a].current_value},a.toggleCtrlSwitch=function(a){f.publish(a,e.datastreams[a].current_value)},e.$watchCollection("currentDataStream.data",function(b){angular.isDefined(b)&&b.length>0&&null!=e.activeStream?(a.chartData=b,a.chartSettings.dataSource=a.chartData,k.updateGauge(e.activeStream,b[b.length-1].value)):(a.chartData=[],a.chartSettings.dataSource=a.chartData),c.hash("2"),d.anchorScroll(),a.$broadcast("scroll.resize"),a.$broadcast("slideBox.update")}),this.updateGauge=function(b,c){a.gaugeScale={startValue:b.minDomain,endValue:b.maxDomain,majorTick:{tickInterval:5},minorTick:{visible:!0,tickInterval:1},label:{customizeText:function(a){return a.valueText}},valueType:"numeric"},a.gaugeRange={ranges:[{startValue:b.minDomain,endValue:b.minCritical,color:"#0077BE"},{startValue:b.minCritical,endValue:b.maxCritical,color:"#E6E200"},{startValue:b.maxCritical,endValue:b.maxDomain,color:"#77DD77"}],offset:5},a.gaugeValue=c,a.gaugeSubvalues=[b.min_value,b.max_value],a.gaugeSettings.scale=a.gaugeScale,a.gaugeSettings.rangeContainer=a.gaugeRange,a.gaugeSettings.value=a.gaugeValue,a.gaugeSettings.subvalues=a.gaugeSubvalues},this.getBackgroundImage=function(b,c,d){i.search(d,b,c).then(function(b){var c=b.photos;c.photo.length&&(a.bgImages=c.photo,k.cycleBgImages())},function(a){console.error("Unable to get Flickr images",a)})},this.getForecast=function(b,c){g.getForecast(b,c).then(function(b){a.forecast=b.forecast.simpleforecast},function(a){alert("Unable to get forecast. Try again later"),console.error(a)}),g.getHourly(b,c).then(function(b){a.hourly=b.hourly_forecast},function(a){alert("Unable to get forecast. Try again later."),console.error(a)})},this.getCurrent=function(b,c){g.getAtLocation(b,c).then(function(b){a.current=b.current_observation,k.getForecast(b.location.lat,b.location.lon)},function(a){alert("Unable to get current conditions"),console.error(a)})},this.cycleBgImages=function(){b(function(){a.bgImages&&(a.activeBgImage=a.bgImages[a.activeBgImageIndex++%a.bgImages.length])})},a.refreshData=function(){f.refresh(),h.getLocation().then(function(a){var b=a.coords.latitude,c=a.coords.longitude;h.reverseGeocode(b,c).then(function(a){k.getBackgroundImage(b,c,a)}),k.getCurrent(b,c)},function(a){alert("Unable to get current location: "+a)})},a.refreshData()}]).controller("SettingsCtrl",["$scope","Settings",function(a,b){a.settings=b.getSettings(),a.$watch("settings",function(){b.save()},!0),a.closeSettings=function(){a.modal.hide()}}]),angular.module("XivelyApp.services",["ngResource"]).constant("DEFAULT_SETTINGS",{tempUnits:"c",keyXively:"6kg3pKWwG6eyx2jRWNrTwSmpOFp9B6kSArV9kWm8iLkJ4gaR",feedXively:"673258092"}).factory("Settings",["$rootScope","DEFAULT_SETTINGS",function(a,b){var c={};try{c=JSON.parse(window.localStorage.settings)}catch(d){}c=angular.extend({},b,c),c||(window.localStorage.settings=JSON.stringify(c));var e={getSettings:function(){return c},save:function(){window.localStorage.settings=JSON.stringify(c),a.$broadcast("settings.changed",c)},get:function(a){return c[a]},set:function(a,b){c[a]=b,this.save()},getTempUnits:function(){return c.tempUnits}};return e.save(),e}]).factory("Geo",["$q",function(a){return{reverseGeocode:function(b,c){var d=a.defer(),e=new google.maps.Geocoder;return e.geocode({latLng:new google.maps.LatLng(b,c)},function(a,b){if(b==google.maps.GeocoderStatus.OK){if(console.log("Reverse",a),a.length>0){for(var c,e,f=a[0],g=[],h=!1,i=!1,j=0;j<f.address_components.length;j++){c=f.address_components[j],e=c.types;for(var k=0;k<e.length;k++)h||"locality"!=e[k]?i||"administrative_area_level_1"!=e[k]||(i=!0):(h=!0,g.push(c.long_name))}console.log("Reverse",g),d.resolve(g.join(" "))}}else console.log("reverse fail",a,b),d.reject(a)}),d.promise},getLocation:function(){var b=a.defer();return navigator.geolocation.getCurrentPosition(function(a){b.resolve(a)},function(a){b.reject(a)}),b.promise}}}]).factory("Flickr",["$q","$resource","FLICKR_API_KEY",function(a,b,c){var d="http://api.flickr.com/services/rest/",e=b(d,{method:"flickr.groups.pools.getPhotos",group_id:"1463451@N25",safe_search:1,jsoncallback:"JSON_CALLBACK",api_key:c,format:"json"},{get:{method:"JSONP"}});return{search:function(b,c,d){var f=a.defer();return console.log("Searching flickr for tags",b),e.get({tags:b,lat:c,lng:d},function(a){f.resolve(a)},function(a){f.reject(a)}),f.promise}}}]).factory("Weather",["$q","$resource","WUNDERGROUND_API_KEY",function(a,b,c){var d="http://api.wunderground.com/api/"+c,e=b(d+"/geolookup/conditions/q/:coords.json",{callback:"JSON_CALLBACK"},{get:{method:"JSONP"}}),f=b(d+"/forecast/q/:coords.json",{callback:"JSON_CALLBACK"},{get:{method:"JSONP"}}),g=b(d+"/hourly/q/:coords.json",{callback:"JSON_CALLBACK"},{get:{method:"JSONP"}});return{getForecast:function(b,c){var d=a.defer();return f.get({coords:b+","+c},function(a){d.resolve(a)},function(a){d.reject(a)}),d.promise},getHourly:function(b,c){var d=a.defer();return g.get({coords:b+","+c},function(a){d.resolve(a)},function(a){d.reject(a)}),d.promise},getAtLocation:function(b,c){var d=a.defer();return e.get({coords:b+","+c},function(a){d.resolve(a)},function(a){d.reject(a)}),d.promise}}}]).factory("xively",["$rootScope","Settings",function($rootScope,Settings){var _this=this,service={},feed_id=Settings.get("feedXively"),feedHistory=Settings.get("feedHistory"),controlTypes=["data","ctrlValue","ctrlSwitch"];return $rootScope.datastreams={},_this.prepareData=function(data){if(data.isSetting=!1,data.newValue=data.current_value,angular.isDefined(data.tags)){var tagString=null,tags=null;for(var i in data.tags)tagString=null===tagString?data.tags[i]:tagString+" ,"+data.tags[i];try{tags=eval("({"+tagString+"})")}catch(e){data.type="undefined"}"undefined"!=data.type&&(data.minDomain=tags.minValue,data.maxDomain=tags.maxValue,data.minCritical=tags.minCritical,data.maxCritical=tags.maxCritical,data.name=tags.name,data.type=tags.type)}return data},_this.init=function(){var a=Settings.get("keyXively");feed_id=Settings.get("feedXively"),feedHistory=Settings.get("feedHistory"),xively.setKey(a),$rootScope.$apply(function(){$rootScope.datastreams={},$rootScope.currentDataStream.data=[]}),xively.datastream.list(feed_id,function(a){var b=[];angular.forEach(a,function(a){_this.prepareData(a),_.contains(controlTypes,a.type)&&b.push(a)}),$rootScope.$apply(function(){$rootScope.dataPoints=b})})},$rootScope.$watch("dataPoints",function(){angular.forEach($rootScope.dataPoints,function(a){xively.datastream.get(feed_id,a.id,function(b){$rootScope.$apply(function(){_this.prepareData(b),$rootScope.datastreams[a.id]=b}),xively.datastream.subscribe(feed_id,a.id,function(b,c){_this.prepareData(c),$rootScope.$apply(function(){$rootScope.datastreams[a.id]=c}),a.id==$rootScope.currentDataStream.id&&($rootScope.currentDataStream.id=c.id,$rootScope.currentDataStream.current_value=c.current_value,$rootScope.$apply(function(){$rootScope.currentDataStream.data.push({value:c.current_value,at:c.at})}))})})}),$rootScope.$broadcast("scroll.refreshComplete")}),xively.refresh=function(){_this.init()},xively.publish=function(a,b){var c={current_value:b};xively.datastream.update(feed_id,a,c,function(){})},xively.get=function(a){(angular.isUndefined(feedHistory)||0==feedHistory)&&(feedHistory=6);var b=feedHistory+"hours";xively.datapoint.history(feed_id,a,{duration:b,interval:30,limit:1e3},function(b){$rootScope.$apply(function(){$rootScope.currentDataStream.id=a,$rootScope.currentDataStream.data=b})})},xively}]),angular.module("XivelyApp.directives",[]).constant("WEATHER_ICONS",{partlycloudy:"ion-ios7-partlysunny-outline",mostlycloudy:"ion-ios7-partlysunny-outline",cloudy:"ion-ios7-cloudy-outline",rain:"ion-ios7-rainy-outline",tstorms:"ion-ios7-thunderstorm-outline",sunny:"ion-ios7-sunny-outline",clear:"ion-ios7-sunny-outline",nt_clear:"ion-ios7-moon-outline",gauge:"ion-power",power:"ion-ios7-gear-outline"}).directive("weatherIcon",["WEATHER_ICONS",function(a){return{restrict:"E",replace:!0,scope:{icon:"="},template:'<i class="icon" ng-class="weatherIcon"></i>',link:function(b){b.$watch("icon",function(c){if(c){var d=c;b.weatherIcon=d in a?a[d]:a.cloudy}})}}}]).directive("currentTime",["$timeout","$filter",function(a,b){return{restrict:"E",replace:!0,template:'<span class="current-time">{{currentTime}}</span>',scope:{localtz:"="},link:function(c){a(function d(){c.localtz&&(c.currentTime=b("date")(+new Date,"HH:mm")),a(d,500)})}}}]).directive("currentWeather",["$timeout","$rootScope","Settings",function(a,b,c){return{restrict:"E",replace:!0,templateUrl:"templates/current-weather.html",scope:!0,compile:function(){return function(d,e){b.$on("settings.changed",function(){var a=c.get("tempUnits");if(d.forecast){var b=d.forecast,e=d.current;"f"==a?(d.highTemp=b.forecastday[0].high.fahrenheit,d.lowTemp=b.forecastday[0].low.fahrenheit,d.currentTemp=Math.floor(e.temp_f)):(d.highTemp=b.forecastday[0].high.celsius,d.lowTemp=b.forecastday[0].low.celsius,d.currentTemp=Math.floor(e.temp_c))}}),d.$watch("current",function(a){var b=c.get("tempUnits");a&&(d.currentTemp=Math.floor("f"==b?a.temp_f:a.temp_c))}),d.$watch("forecast",function(a){var b=c.get("tempUnits");a&&("f"==b?(d.highTemp=a.forecastday[0].high.fahrenheit,d.lowTemp=a.forecastday[0].low.fahrenheit):(d.highTemp=a.forecastday[0].high.celsius,d.lowTemp=a.forecastday[0].low.celsius))}),a(function(){var b=window.innerHeight,c=e[0].offsetHeight;e[0].style.paddingTop=b-c-25+"px",angular.element(document.querySelector(".scroll-content")).css("-webkit-overflow-scrolling","auto"),a(function(){angular.element(document.querySelector(".scroll-content")).css("-webkit-overflow-scrolling","touch")},50)})}}}}]).directive("xively",["$timeout",function(){return{restrict:"E",replace:!0,templateUrl:"templates/xively.html",link:function(){}}}]).directive("forecast",["$timeout",function(){return{restrict:"E",replace:!0,templateUrl:"templates/forecast.html",link:function(){}}}]).directive("weatherBox",["$timeout",function(){return{restrict:"E",replace:!0,transclude:!0,scope:{title:"@"},template:'<div class="weather-box"><h4 class="title">{{title}}</h4><div ng-transclude></div></div>',link:function(){}}}]).directive("backgroundCycler",["$compile","$animate",function(a,b){var c=function(c,d,e){var f=d.children()[0],g=c.$new();g.url=e;var h=a("<background-image></background-image>")(g);b.enter(h,d,null,function(){console.log("Inserted")}),f&&b.leave(angular.element(f),function(){console.log("Removed")})};return{restrict:"E",link:function(a,b){a.$watch("activeBgImage",function(d){if(d){console.log("Active bg image changed",d);var e=d,f="http://farm"+e.farm+".static.flickr.com/"+e.server+"/"+e.id+"_"+e.secret+"_z.jpg";c(a,b,f)}})}}}]).directive("backgroundImage",["$compile","$animate",function(){return{restrict:"E",template:'<div class="bg-image"></div>',replace:!0,scope:!0,link:function(a,b){a.url&&(b[0].style.backgroundImage="url("+a.url+")")}}}]),angular.module("XivelyApp.filters",["XivelyApp.services"]).filter("temp",["Settings",function(a){return function(b){return"f"==a.getTempUnits()?b.fahrenheit:b.celsius}}]).filter("tempEnglish",["Settings",function(a){return function(b){return"f"==a.getTempUnits()?b.english:b.metric}}]).filter("hourFormat",function(){return function(a){var b=parseInt(a),c=b>=12?"PM":"AM",d=b%12||12;return d+c}});